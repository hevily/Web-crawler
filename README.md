# Web-crawler
爬虫、代理IP池、识别验证码

一、项目基本情况
    手头有份数据量大约8万的公司名单，客户需求是从百度企业信用、企查查等网站获取公司注册地址信息。
    对比了企查查、阿里企业黄页等网站，敲定使用百度企业信用作为爬虫对象。
    
    百度企业信用网站，有一些反爬虫机制。如连续访问8次需要输入一次验证码，同一个IP连续72次会被禁止访问半天。
    因此本项目建立了代理IP池等方式进行反反爬虫。
 
 
 
 二、项目策略及思路
 
 本次项目需要从网页上获取的信息只有地址信息，因此从网站提取信息部分并不复杂；提取得到的信息也十分“干净”，可以直接入库，不需要再进行清洗。
 因此项目的重点及难点在于目标网站的反爬虫导致的需要输入验证码及封IP的问题。
 
 1.反“反爬虫”策略
 
 
 
 （1）输入验证码:
 
 
      1）调用Selenium库进行截屏、获取验证码图片并保存至本地；
      
      
	  2）调用云打码平台：识别验证码，返回文字形式的验证码
      
      
      
（2）封IP：构建IP代理池

     1）获取免费IP地址：对比西刺、站大爷等多个免费代理IP网站，最终选定可用IP较多的免费代理网站（http://ip.jiangxianli.com/）

     2）使用urllib获取网页内容，提取网页内容中的IP和端口信息。
     
     3）由于免费IP不稳定性较高，可用的时效性短，因此每次爬虫仅爬前5个页面。
     
     4）验证IP是否可用。
 

2.免费IP稳定性差应对策略

     免费IP最大的问题就是稳定性差，访问速度慢。在从网页提取地址信息执行过程中，为了防止因IP突然不可访问网络导致程序崩溃，使用try--except 和 while应对。
     
     输入要搜索的公司并点击搜索后，网站可能出现的情况如下：【成功得到地址】、【没找到公司信息】、【输入验证码】、【IP无法访问网站】、【网速过慢无法正常打开网页】、【网页禁止访问】
     设置while循环，把网站可能出现的情况对应的代码块包含在while循环当中。
     
     （1）只有【成功得到地址】和【没找到公司信息】两种情况下停止while循环，搜索下一个公司；
     
     （2）否则，其他情况下都不会停止while循环：
          1）出现【输入验证码】的情况，代码块的功能是：调用截图函数、识别验证码函数进行验证码识别。
         
          我们来梳理一下输入验证码后可能会出现的情况：
          如果验证码输入正确，会出现【成功得到地址】或【没找到公司信息】两种情况；
          如果验证码输入不正确，页面依然是【输入验证码】的情况。
          也可能ip失效，网页不可访问了。
          
          因此，输入验证码后，又需要重新判断网页目前所处的情况。如果又把可能出现的情况的代码块又码在这里，就很累赘了。
          
          设置while的好处在于，while遇到False才会停止循环，此处只要不设置False，输入完验证码以后就会去判断目前网页处于何种情况并跳转到该代码块，直到遇到【成功得到地址】或【没找到公司信息】停止while循环。
          
          
     
          2）其他情况：
	  如【IP无法访问网站】、【网速过慢无法正常打开网页】、【网页禁止访问】，这些情况都无法获得想要的结果。
          这些情况下都需要更换ip，重新输入公司名称并点击搜索。
	  更换ip，重新输入公司名称并点击搜索后，会跟【输入验证码】情况类似，就是需要判断网页所处情况。因此代码功能处理方式跟出现【输入验证码】的情况类似。



3.项目伪代码
 
 
    1）从免费IP代理网站获取IP，验证可用后存储于本地。
    2）从上一步生成的可用IP池中随机选取IP，验证IP可访问目标网站；
       遍历公司：
            在网页中公司输入框汇中输入公司名称
            点击搜索
            while：
                 try：
                     地址信息在网站中存在，地址存储到本地，无结果存储到本地，结束while循环
                     
                 except：
                     ###地址信息不存在，报错###
                     
                      if 没找到公司信息：
                          无结果存储到本地，结束while循环
                          
                      elif  需要输入验证码：
                         网页截屏，根据验证码在网页中的位置，将验证码保存为图片存于本地
                         
                         调用云打码平台，识别验证码图片，返回文字形式的验证码
                         
                         获取网页‘输入验证码’输入框，发送上一步的验证码
                         
                       else：
                         使用新IP重新搜索公司	     
 
 
 三、文件说明：
 
 getidadd.py------从免费代理IP网站获取IP地址及端口号，并验证IP是否可用。先运行
 getcomadd.py-----从百度企业信用网站提取地址信息，将地址信息存储于本地。后运行
    
